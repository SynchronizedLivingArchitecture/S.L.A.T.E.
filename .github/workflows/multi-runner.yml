# S.L.A.T.E. Multi-Runner Workflow
# Enables parallel execution across hosted + self-hosted runners
# Modified: 2026-02-06T23:20:00Z | Author: COPILOT | Change: Initial implementation

name: Multi-Runner Tasks

on:
  workflow_dispatch:
    inputs:
      task_type:
        description: 'Task type to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - lint
          - tests
          - security
          - gpu-benchmark
  push:
    branches: [main]
    paths:
      - 'slate/**'
      - 'tests/**'

concurrency:
  group: multi-runner-${{ github.ref }}
  cancel-in-progress: false  # Allow parallel runs

permissions:
  contents: read

# Matrix strategy: Run on BOTH hosted and self-hosted runners
jobs:
  # ============================================
  # FAST JOBS - GitHub Hosted Runners (Free tier)
  # ============================================
  lint-hosted:
    name: Lint (Hosted)
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.task_type == 'all' || github.event.inputs.task_type == 'lint' || github.event_name == 'push' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install ruff
        run: pip install ruff
      - name: Lint
        run: ruff check slate/ agents/ --output-format=github

  security-hosted:
    name: Security (Hosted)
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.task_type == 'all' || github.event.inputs.task_type == 'security' || github.event_name == 'push' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install bandit
        run: pip install bandit
      - name: Security scan
        run: bandit -r slate/ agents/ -ll -ii -x "**/test*"

  # ============================================
  # PARALLEL JOBS - Self-Hosted Runners (GPU)
  # ============================================
  tests-gpu-0:
    name: Tests GPU 0
    runs-on: [self-hosted, slate, gpu]
    if: ${{ github.event.inputs.task_type == 'all' || github.event.inputs.task_type == 'tests' || github.event_name == 'push' }}
    env:
      CUDA_VISIBLE_DEVICES: "0"
    defaults:
      run:
        shell: powershell
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        run: |
          'E:\11132025\.venv\Scripts' | Out-File -Append $env:GITHUB_PATH
      - name: Run tests (GPU 0)
        run: |
          python -m pytest tests/ -v --tb=short -x -k "not integration"
        continue-on-error: true

  tests-gpu-1:
    name: Tests GPU 1
    runs-on: [self-hosted, slate, gpu]
    if: ${{ github.event.inputs.task_type == 'all' || github.event.inputs.task_type == 'tests' || github.event_name == 'push' }}
    env:
      CUDA_VISIBLE_DEVICES: "1"
    defaults:
      run:
        shell: powershell
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        run: |
          'E:\11132025\.venv\Scripts' | Out-File -Append $env:GITHUB_PATH
      - name: Run integration tests (GPU 1)
        run: |
          python -m pytest tests/integration/ -v --tb=short -x
        continue-on-error: true

  gpu-benchmark:
    name: GPU Benchmark
    runs-on: [self-hosted, slate, gpu]
    if: ${{ github.event.inputs.task_type == 'gpu-benchmark' }}
    env:
      CUDA_VISIBLE_DEVICES: "0,1"
    defaults:
      run:
        shell: powershell
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        run: |
          'E:\11132025\.venv\Scripts' | Out-File -Append $env:GITHUB_PATH
      - name: Multi-runner benchmark
        run: python slate/slate_runner_benchmark.py --json
      - name: Multi-runner status
        run: python slate/slate_multi_runner.py --json

  # ============================================
  # SDK VALIDATION - Self-Hosted (needs local venv)
  # ============================================
  sdk-validation:
    name: SDK Validation
    runs-on: [self-hosted, slate]
    if: ${{ github.event.inputs.task_type == 'all' || github.event_name == 'push' }}
    defaults:
      run:
        shell: powershell
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        run: |
          'E:\11132025\.venv\Scripts' | Out-File -Append $env:GITHUB_PATH
      - name: Validate imports
        run: |
          python -c "import slate; print(f'SLATE v{slate.__version__}')"
          python -c "from slate.slate_multi_runner import MultiRunnerCoordinator; print('Multi-runner OK')"
          python -c "from slate.slate_runner_benchmark import RunnerBenchmark; print('Benchmark OK')"

  # ============================================
  # SUMMARY
  # ============================================
  summary:
    name: Multi-Runner Summary
    runs-on: ubuntu-latest
    needs: [lint-hosted, security-hosted, tests-gpu-0, tests-gpu-1, sdk-validation]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Multi-Runner Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Hosted Runners (GitHub)" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint-hosted.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security-hosted.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Self-Hosted Runners (GPU)" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status | GPU |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests GPU 0 | ${{ needs.tests-gpu-0.result }} | 0 |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests GPU 1 | ${{ needs.tests-gpu-1.result }} | 1 |" >> $GITHUB_STEP_SUMMARY
          echo "| SDK Validation | ${{ needs.sdk-validation.result }} | - |" >> $GITHUB_STEP_SUMMARY
