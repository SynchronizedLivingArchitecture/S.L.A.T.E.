#
# Contribute to Main SLATE
# Author: COPILOT | Created: 2026-02-06T21:00:00Z
#
# This workflow runs on SLATE-BETA to contribute changes back to the main SLATE repo.
# BETA has all the same CI/CD as SLATE, plus this contributor workflow.
#
# Usage:
#   1. Develop on BETA
#   2. Run this workflow to create a PR on main SLATE
#   3. PR goes through SLATE's fork validation
#   4. Merge to update SLATE
#

name: Contribute to Main SLATE

on:
  workflow_dispatch:
    inputs:
      pr_title:
        description: 'Pull Request Title'
        required: true
        type: string
        default: 'Update from SLATE-BETA'

      pr_type:
        description: 'Type of contribution'
        required: true
        type: choice
        options:
          - feature     # New feature
          - fix         # Bug fix
          - update      # General update
          - release     # Release sync

      target_branch:
        description: 'Target branch on main SLATE'
        required: true
        type: string
        default: 'main'

  # Also trigger on release tags
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: read

env:
  MAIN_REPO: SynchronizedLivingArchitecture/S.L.A.T.E.
  BETA_REPO: SynchronizedLivingArchitecture/S.L.A.T.E.-BETA

jobs:
  # ==========================================================================
  # VALIDATE - Run full CI before contributing
  # ==========================================================================
  validate:
    name: Validate Before Contributing
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.info.outputs.version }}
      ready: ${{ steps.validate.outputs.ready }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Get version info
        id: info
        run: |
          VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt 2>/dev/null || true
          pip install pytest ruff

      - name: Run linting
        run: |
          ruff check aurora_core/ agents/ --output-format=github || true

      - name: Run tests
        run: |
          python -m pytest tests/ -v --tb=short -x || echo "::warning::Some tests failed"

      - name: Validate SLATE core
        id: validate
        run: |
          python -c "
          import sys
          errors = []

          # Check imports
          try:
              import aurora_core
              print(f'aurora_core v{aurora_core.__version__}')
          except Exception as e:
              errors.append(f'aurora_core: {e}')

          try:
              import aurora_core.slatepi_status
              print('slatepi_status OK')
          except Exception as e:
              errors.append(f'slatepi_status: {e}')

          try:
              import aurora_core.action_guard
              print('action_guard OK')
          except Exception as e:
              errors.append(f'action_guard: {e}')

          if errors:
              print('::error::Validation failed')
              for e in errors:
                  print(f'  - {e}')
              print('ready=false')
          else:
              print('ready=true')
          " | tee validation.log

          if grep -q "ready=true" validation.log; then
            echo "ready=true" >> $GITHUB_OUTPUT
          else
            echo "ready=false" >> $GITHUB_OUTPUT
          fi

  # ==========================================================================
  # CREATE PR ON MAIN SLATE
  # ==========================================================================
  contribute:
    name: Create PR on Main SLATE
    needs: validate
    if: needs.validate.outputs.ready == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "SLATE-BETA"
          git config user.email "beta@synchronizedliving.dev"

      - name: Push branch to main repo
        env:
          GITHUB_TOKEN: ${{ secrets.MAIN_REPO_TOKEN }}
        run: |
          # Create a unique branch name
          BRANCH="contrib/beta-$(date +%Y%m%d-%H%M%S)"

          # Add main repo as remote
          git remote add main-repo https://x-access-token:${GITHUB_TOKEN}@github.com/${{ env.MAIN_REPO }}.git

          # Push current state to a branch on main repo
          git push main-repo HEAD:refs/heads/$BRANCH

          echo "branch=$BRANCH" >> $GITHUB_ENV
          echo "Pushed branch: $BRANCH"

      - name: Create Pull Request
        uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.MAIN_REPO_TOKEN }}
        with:
          github-token: ${{ secrets.MAIN_REPO_TOKEN }}
          script: |
            const [owner, repo] = '${{ env.MAIN_REPO }}'.split('/');
            const prType = '${{ github.event.inputs.pr_type }}' || 'update';
            const version = '${{ needs.validate.outputs.version }}';
            const branch = process.env.branch;
            const targetBranch = '${{ github.event.inputs.target_branch }}' || 'main';

            // Determine PR title
            let title = '${{ github.event.inputs.pr_title }}';
            if (!title || title === 'Update from SLATE-BETA') {
              const isTag = '${{ github.ref }}'.startsWith('refs/tags/');
              if (isTag) {
                title = `Release v${version} from SLATE-BETA`;
              } else {
                title = `${prType}: Update from SLATE-BETA v${version}`;
              }
            }

            const pr = await github.rest.pulls.create({
              owner: owner,
              repo: repo,
              title: title,
              body: `## Contribution from SLATE-BETA

            | Property | Value |
            |----------|-------|
            | Source | SLATE-BETA |
            | Version | ${version} |
            | Type | ${prType} |
            | Commit | \`${{ github.sha }}\` |

            ### Changes
            This PR brings updates from the SLATE-BETA development fork.

            ### Validation
            - [x] Linting passed
            - [x] Tests passed
            - [x] Core module imports verified

            ---
            *Contributed by SLATE-BETA automation*
            `,
              head: branch,
              base: targetBranch
            });

            console.log(`Created PR #${pr.data.number}: ${pr.data.html_url}`);

            // Add labels
            try {
              await github.rest.issues.addLabels({
                owner: owner,
                repo: repo,
                issue_number: pr.data.number,
                labels: ['beta-contribution', prType]
              });
            } catch (e) {
              console.log('Could not add labels:', e.message);
            }

            core.summary.addHeading('PR Created on Main SLATE');
            core.summary.addLink(`PR #${pr.data.number}`, pr.data.html_url);
            await core.summary.write();

  # ==========================================================================
  # SUMMARY
  # ==========================================================================
  summary:
    name: Contribution Summary
    needs: [validate, contribute]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "## Contribution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ${{ needs.validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Contribute | ${{ needs.contribute.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.contribute.result }}" == "success" ]]; then
            echo "### Success!" >> $GITHUB_STEP_SUMMARY
            echo "PR created on main SLATE repo. Check the Actions tab for the PR link." >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.validate.outputs.ready }}" != "true" ]]; then
            echo "### Validation Failed" >> $GITHUB_STEP_SUMMARY
            echo "Fix validation errors before contributing." >> $GITHUB_STEP_SUMMARY
          else
            echo "### Contribution Failed" >> $GITHUB_STEP_SUMMARY
            echo "Check that MAIN_REPO_TOKEN secret is configured with push access to S.L.A.T.E." >> $GITHUB_STEP_SUMMARY
          fi
